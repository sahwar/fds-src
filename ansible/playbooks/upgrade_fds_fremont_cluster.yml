---

-   name: stop FDS on all nodes
    hosts: fremont_node_cluster
    remote_user: root

    tasks:
    -   name: Stop FDS
        command: /fds/sbin/tools/fds stop

    -   name: check process status
        command: /fds/sbin/tools/fds status
        register: fdsadmin_output
        tags:
            -   dbg
    -   debug: var=fdsadmin_output.stdout_lines

-   name: install and configure fds on all  fds_nodes
    hosts: fremont_node_cluster
    remote_user: root
    vars_files:
        - ../vars_files/node_spec_fremont.yml

    handlers:
    -   name: restart ssh
        service: name=ssh state=restarted

    tasks:
    -   name: copy fdsinstall tarball
        action: copy src=resources/fdsinstall.tgz dest=/root/fdsinstall.tgz owner=root group=root mode=0644

    -   name: extract fdsinstall tarball
        action: unarchive creates=/root/fdsinstall src=/root/fdsinstall.tgz dest=/root copy=no

    -   name: run fdsinstall step 2 - install external pkgs
        shell: ./fdsinstall.py -o 5 -o 2  && touch /root/.fdsinstall_step2_ran chdir=/root/fdsinstall creates=/root/.fdsinstall_step2_ran

    -   name: run fdsinstall step 3 - setup storage
        shell: ./fdsinstall.py -o 5 -o 3  && touch /root/.fdsinstall_step3_ran chdir=/root/fdsinstall creates=/root/.fdsinstall_step3_ran

    -   name: run fdsinstall step 4 - install FDS pkgs
        shell: ./fdsinstall.py -o 5 -o 4  && touch /root/.fdsinstall_step4_ran chdir=/root/fdsinstall creates=/root/.fdsinstall_step4_ran

    -   name: render formation.conf
        action: template src=../templates/formation.conf.j2 dest=/fds/sbin/formation.conf owner=root group=root mode=0644

    -   name: render platform.conf
        action: template src=../templates/platform.conf.j2 dest=/fds/etc/platform.conf owner=root group=root mode=0644

    -   name: render orch_mgr.conf
        action: template src=../templates/orch_mgr.conf.j2 dest=/fds/etc/orch_mgr.conf owner=root group=root mode=0644

    -   name: fix FdsSetup.py
        command: sed -ie 's/return_stdin[)]:/return_stdin=False):/g' FdsSetup.py chdir=/usr/local/lib/python2.7/dist-packages/fdslib

    -   name: allow ssh root login
        command: sed -ie 's/PermitRootLogin without-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
        notify: restart ssh


-   name: start FDS from first node
    hosts: node0.formationds.com
    remote_user: root

# shell: bash -lxc "./fds-tool.py -f formation.conf -u -v" chdir=/fds/sbin
    tasks:
    -   name: attempt to start FDS
#        shell: bash -lc "./x.py" chdir=/fds/sbin
#        command: bash -lc "./x.py" chdir=/fds/sbin
        shell: bash -lc "./x.py" chdir=/fds/sbin
#        raw: which python
        register: fds-tool_output
        tags:
            -   dbg
    -   debug: var=fds-tool_output

    -   name: check process status
        command: ./fdsadmin --process-status chdir=/fds/sbin
        register: fdsadmin_output
        tags:
            -   dbg
    -   debug: var=fdsadmin_output.stdout_lines
